name: Publish Docker Images

on:
  workflow_dispatch:
    inputs:
      branch_or_tag:
        description: 'Branch or tag to checkout (e.g., master, 0.295)'
        required: true
        default: 'master'
      os:
        description: 'Operating system (ubuntu/centos)'
        required: true
        default: 'centos'
        type: choice
        options:
          - centos
          - ubuntu
      tag_suffix:
        description: 'Tag suffix (can be empty)'
        required: false
        default: ''
      tag_latest:
        description: 'Tag the image as latest'
        type: boolean
        default: true
        required: false
      publish_dependency:
        description: 'Publish dependency image'
        type: boolean
        default: true
        required: false
      publish_presto:
        description: 'Publish presto images'
        type: boolean
        default: true
        required: false
      publish_prestissimo:
        description: 'Publish prestissimo images'
        type: boolean
        default: true
        required: false

env:
  JAVA_VERSION: ${{ vars.JAVA_VERSION || '17' }}
  JAVA_DISTRIBUTION: ${{ vars.JAVA_DISTRIBUTION || 'temurin' }}
  DOCKER_REPO: ${{ github.repository }}
  ORG_NAME: ${{ github.repository_owner }}
  GIT_CI_USER: ${{ vars.GIT_CI_USER || 'prestodb-ci' }}
  GIT_CI_EMAIL: ${{ vars.GIT_CI_EMAIL || 'ci@lists.prestodb.io' }}
  JMX_PROMETHEUS_JAVAAGENT_VERSION: 0.20.0

jobs:
  publish-dependency-image:
    if: ( !failure() && !cancelled() && github.event.inputs.publish_dependency == 'true' )
    strategy:
      matrix:
        arch: [amd64, arm64]
      fail-fast: false
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    environment: release
    timeout-minutes: 150
    permissions:
      packages: write
      contents: read
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          docker-images: false
          large-packages: false

      - name: Set up JDK ${{ env.JAVA_DISTRIBUTION }}/${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch_or_tag }}
          fetch-depth: 1

      - name: Configure git
        if: ${{ inputs.publish_dependency == 'true' }}
        run: |
          git config --global user.email "${{ env.GIT_CI_EMAIL }}"
          git config --global user.name "${{ env.GIT_CI_USER }}"

          echo "Currently on: $(git rev-parse --abbrev-ref HEAD)"
          echo "Commit SHA: $(git rev-parse HEAD)"
          echo "COMMIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Checkout submodules
        working-directory: presto-native-execution
        run: |
          df -h
          make submodules

      - name: Extract version
        run: |
          VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "Raw version: $VERSION"

          if [ -z "$VERSION" ]; then
            echo "Failed to extract project version with Maven"
            exit 1
          fi

          if [[ "$VERSION" == *"-SNAPSHOT" ]]; then
            # Remove -SNAPSHOT and append commit SHA
            CLEAN_VERSION=${VERSION%-SNAPSHOT}
            TAG_VERSION="${CLEAN_VERSION}-${COMMIT_SHA}"
            echo "SNAPSHOT version detected, using: $TAG_VERSION"
          else
            TAG_VERSION="$VERSION"
            echo "Release version detected, using: $TAG_VERSION"
          fi

          echo "VERSION=$TAG_VERSION" >> $GITHUB_ENV

      - name: Login to DockerHub
        uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.0.0
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@29109295f81e9208d7d86ff1c6c12d2833863392 # v3.0.0

      - name: Set up buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3.0.0

      - name: Set up builder
        run: |
          docker buildx create --name container --use
          docker buildx inspect --bootstrap

      - name: Set image tag
        run: |
          IMAGE_NAME="presto-native-dependency"
          TAG_BASE="${{ env.ORG_NAME }}/${IMAGE_NAME}:${{ inputs.os }}-${{ env.VERSION }}-${{ matrix.arch }}"

          if [[ -n "${{ inputs.tag_suffix }}" ]]; then
            echo "IMAGE_TAG=${TAG_BASE}-${{ inputs.tag_suffix }}" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=${TAG_BASE}" >> $GITHUB_ENV
          fi

          if [[ "${{ inputs.os }}" == "ubuntu" ]]; then
            echo "DEPENDENCY_TARGET=ubuntu-native-dependency" >> $GITHUB_ENV
            echo "LOCAL_IMAGE_TAG=presto/prestissimo-dependency:ubuntu-22.04" >> $GITHUB_ENV
          else
            echo "DEPENDENCY_TARGET=centos-native-dependency" >> $GITHUB_ENV
            echo "LOCAL_IMAGE_TAG=presto/prestissimo-dependency:centos9" >> $GITHUB_ENV
          fi

          # Store the dependency image tag for later jobs
          echo "DEPENDENCY_IMAGE_TAG=${TAG_BASE}" >> $GITHUB_ENV

      - name: Build image
        working-directory: presto-native-execution
        run: |
          df -h
          echo "Using image tag: $IMAGE_TAG"

          if [[ "${{ matrix.arch }}" == "arm64" ]]; then
            BUILD_ARGS="--build-arg ARM_BUILD_TARGET=generic"
          else
            BUILD_ARGS=""
          fi

          echo "BUILD_ARGS=${BUILD_ARGS}"
          docker compose build ${BUILD_ARGS} ${{ env.DEPENDENCY_TARGET }}

      - name: Publish image
        run: |
          set -e
          docker tag ${{ env.LOCAL_IMAGE_TAG }} ${{ env.IMAGE_TAG }}
          docker push ${{ env.IMAGE_TAG }}

          if [[ "${{ inputs.tag_latest }}" == "true" ]]; then
            LATEST_TAG="${{ env.ORG_NAME }}/presto-native-dependency:${{ inputs.os }}-${{ matrix.arch }}-latest"
            docker tag ${{ env.LOCAL_IMAGE_TAG }} ${LATEST_TAG}
            docker push ${LATEST_TAG}
            echo "Tagged and pushed as latest: ${LATEST_TAG}"
          fi

  create-dependency-manifest:
    if: ( !failure() && !cancelled() && github.event.inputs.publish_dependency == 'true' )
    needs: publish-dependency-image
    runs-on: ubuntu-latest
    environment: release
    permissions:
      packages: write
      contents: read
    steps:
      - name: Login to DockerHub
        uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.0.0
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch_or_tag }}
          fetch-depth: 1

      - name: Extract version
        run: |
          VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "Raw version: $VERSION"

          if [ -z "$VERSION" ]; then
            echo "Failed to extract project version with Maven"
            exit 1
          fi

          if [[ "$VERSION" == *"-SNAPSHOT" ]]; then
            # Remove -SNAPSHOT and append commit SHA
            CLEAN_VERSION=${VERSION%-SNAPSHOT}
            COMMIT_SHA=$(git rev-parse --short HEAD)
            TAG_VERSION="${CLEAN_VERSION}-${COMMIT_SHA}"
            echo "SNAPSHOT version detected, using: $TAG_VERSION"
          else
            TAG_VERSION="$VERSION"
            echo "Release version detected, using: $TAG_VERSION"
          fi

          echo "VERSION=$TAG_VERSION" >> $GITHUB_ENV

      - name: Create and push multi-arch manifest
        run: |
          ORG_NAME="${{ github.repository_owner }}"
          IMAGE_NAME="presto-native-dependency"
          OS="${{ inputs.os }}"
          VERSION="${{ env.VERSION }}"

          # Determine tag suffix
          if [[ -n "${{ inputs.tag_suffix }}" ]]; then
            TAG_SUFFIX="-${{ inputs.tag_suffix }}"
          else
            TAG_SUFFIX=""
          fi

          # Create manifest for the versioned tag
          MANIFEST_TAG="${ORG_NAME}/${IMAGE_NAME}:${OS}-${VERSION}${TAG_SUFFIX}"
          AMD64_TAG="${ORG_NAME}/${IMAGE_NAME}:${OS}-${VERSION}-amd64${TAG_SUFFIX}"
          ARM64_TAG="${ORG_NAME}/${IMAGE_NAME}:${OS}-${VERSION}-arm64${TAG_SUFFIX}"

          echo "Creating manifest: ${MANIFEST_TAG}"
          docker manifest create ${MANIFEST_TAG} ${AMD64_TAG} ${ARM64_TAG}
          docker manifest push ${MANIFEST_TAG}

          # Create latest manifest if requested
          if [[ "${{ inputs.tag_latest }}" == "true" ]]; then
            # Create OS-specific latest manifest
            LATEST_MANIFEST="${ORG_NAME}/${IMAGE_NAME}:${OS}-latest"
            LATEST_AMD64="${ORG_NAME}/${IMAGE_NAME}:${OS}-amd64-latest"
            LATEST_ARM64="${ORG_NAME}/${IMAGE_NAME}:${OS}-arm64-latest"

            echo "Creating OS-specific latest manifest: ${LATEST_MANIFEST}"
            docker manifest create ${LATEST_MANIFEST} ${LATEST_AMD64} ${LATEST_ARM64}
            docker manifest push ${LATEST_MANIFEST}

            # If OS is centos, also tag as latest (without OS prefix)
            if [[ "${OS}" == "centos" ]]; then
              GLOBAL_LATEST="${ORG_NAME}/${IMAGE_NAME}:latest"
              echo "Creating global latest manifest: ${GLOBAL_LATEST}"
              docker manifest create ${GLOBAL_LATEST} ${LATEST_AMD64} ${LATEST_ARM64}
              docker manifest push ${GLOBAL_LATEST}
            fi
          fi

  publish-presto-image:
    if: (!failure() && !cancelled() && github.event.inputs.publish_presto == 'true')
    strategy:
      matrix:
        arch: [amd64, arm64]
      fail-fast: false
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    environment: release
    timeout-minutes: 150
    permissions:
      packages: write
      contents: read
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          docker-images: false
          large-packages: false

      - name: Set up JDK ${{ env.JAVA_DISTRIBUTION }}/${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch_or_tag }}
          fetch-depth: 1

      - name: Configure git
        run: |
          git config --global user.email "${{ env.GIT_CI_EMAIL }}"
          git config --global user.name "${{ env.GIT_CI_USER }}"

          echo "Currently on: $(git rev-parse --abbrev-ref HEAD)"
          echo "Commit SHA: $(git rev-parse HEAD)"
          echo "COMMIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Extract version
        run: |
          VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "Raw version: $VERSION"

          if [ -z "$VERSION" ]; then
            echo "Failed to extract project version with Maven"
            exit 1
          fi

          if [[ "$VERSION" == *"-SNAPSHOT" ]]; then
            # Remove -SNAPSHOT and append commit SHA
            CLEAN_VERSION=${VERSION%-SNAPSHOT}
            TAG_VERSION="${CLEAN_VERSION}-${COMMIT_SHA}"
            echo "SNAPSHOT version detected, using: $TAG_VERSION"
          else
            TAG_VERSION="$VERSION"
            echo "Release version detected, using: $TAG_VERSION"
          fi

          echo "VERSION=$TAG_VERSION" >> $GITHUB_ENV
          echo "JAR_VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build Presto Server
        run: |
          df -h
          ./mvnw clean install -DskipTests -T1C
          df -h

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set image tag and base image
        run: |
          IMAGE_NAME="presto"
          TAG_BASE="${{ env.ORG_NAME }}/${IMAGE_NAME}:${{ env.VERSION }}-${{ matrix.arch }}"

          if [[ -n "${{ inputs.tag_suffix }}" ]]; then
            echo "IMAGE_TAG=${TAG_BASE}-${{ inputs.tag_suffix }}" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=${TAG_BASE}" >> $GITHUB_ENV
          fi

      - name: Move artifacts to docker directory
        run: |
          mkdir -p docker_build
          cp presto-server/target/presto-server-*.tar.gz docker/
          cp presto-cli/target/presto-cli-*-executable.jar docker/

      - name: Build and push Docker image
        run: |
          cd docker

          # Build the Docker image
          docker build \
            --build-arg PRESTO_VERSION=${{ env.VERSION }} \
            --build-arg PRESTO_PKG=presto-server-${{ env.JAR_VERSION }}.tar.gz \
            --build-arg PRESTO_CLI_JAR=presto-cli-${{ env.JAR_VERSION }}-executable.jar \
            --build-arg JMX_PROMETHEUS_JAVAAGENT_VERSION=${{ env.JMX_PROMETHEUS_JAVAAGENT_VERSION }} \
            -t ${{ env.IMAGE_TAG }} .

          # Push the image
          docker push ${{ env.IMAGE_TAG }}

          # Tag and push as latest if requested
          if [[ "${{ inputs.tag_latest }}" == "true" ]]; then
            LATEST_TAG="${{ env.ORG_NAME }}/presto:${{ matrix.arch }}-latest"
            docker tag ${{ env.IMAGE_TAG }} ${LATEST_TAG}
            docker push ${LATEST_TAG}
            echo "Tagged and pushed as latest: ${LATEST_TAG}"
          fi

  create-presto-manifest:
    if: (!failure() && !cancelled() && github.event.inputs.publish_presto == 'true')
    needs: publish-presto-image
    runs-on: ubuntu-latest
    environment: release
    permissions:
      packages: write
      contents: read
    steps:
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch_or_tag }}
          fetch-depth: 1

      - name: Extract version
        run: |
          VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "Raw version: $VERSION"

          if [ -z "$VERSION" ]; then
            echo "Failed to extract project version with Maven"
            exit 1
          fi

          if [[ "$VERSION" == *"-SNAPSHOT" ]]; then
            # Remove -SNAPSHOT and append commit SHA
            CLEAN_VERSION=${VERSION%-SNAPSHOT}
            COMMIT_SHA=$(git rev-parse --short HEAD)
            TAG_VERSION="${CLEAN_VERSION}-${COMMIT_SHA}"
            echo "SNAPSHOT version detected, using: $TAG_VERSION"
          else
            TAG_VERSION="$VERSION"
            echo "Release version detected, using: $TAG_VERSION"
          fi

          echo "VERSION=$TAG_VERSION" >> $GITHUB_ENV

      - name: Create and push multi-arch manifest
        run: |
          ORG_NAME="${{ github.repository_owner }}"
          IMAGE_NAME="presto"
          VERSION="${{ env.VERSION }}"

          # Determine tag suffix
          if [[ -n "${{ inputs.tag_suffix }}" ]]; then
            TAG_SUFFIX="-${{ inputs.tag_suffix }}"
          else
            TAG_SUFFIX=""
          fi

          # Create manifest for the versioned tag
          MANIFEST_TAG="${ORG_NAME}/${IMAGE_NAME}:${VERSION}${TAG_SUFFIX}"
          AMD64_TAG="${ORG_NAME}/${IMAGE_NAME}:${VERSION}-amd64${TAG_SUFFIX}"
          ARM64_TAG="${ORG_NAME}/${IMAGE_NAME}:${VERSION}-arm64${TAG_SUFFIX}"

          echo "Creating manifest: ${MANIFEST_TAG}"
          docker manifest create ${MANIFEST_TAG} ${AMD64_TAG} ${ARM64_TAG}
          docker manifest push ${MANIFEST_TAG}

          # Create latest manifest if requested
          if [[ "${{ inputs.tag_latest }}" == "true" ]]; then
            LATEST_MANIFEST="${ORG_NAME}/${IMAGE_NAME}:latest"
            LATEST_AMD64="${ORG_NAME}/${IMAGE_NAME}:amd64-latest"
            LATEST_ARM64="${ORG_NAME}/${IMAGE_NAME}:arm64-latest"

            echo "Creating latest manifest: ${LATEST_MANIFEST}"
            docker manifest create ${LATEST_MANIFEST} ${LATEST_AMD64} ${LATEST_ARM64}
            docker manifest push ${LATEST_MANIFEST}
          fi

  publish-prestissimo-image:
    if: (!failure() && !cancelled() && github.event.inputs.publish_prestissimo == 'true')
    needs: [publish-dependency-image]
    strategy:
      matrix:
        arch: [amd64, arm64]
      fail-fast: false
    runs-on: ${{ matrix.arch == 'arm64' && 'ubuntu-24.04-arm' || 'ubuntu-latest' }}
    environment: release
    timeout-minutes: 150
    permissions:
      packages: write
      contents: read
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@v1.3.1
        with:
          tool-cache: false
          docker-images: false
          large-packages: false

      - name: Set up JDK ${{ env.JAVA_DISTRIBUTION }}/${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch_or_tag }}
          fetch-depth: 1

      - name: Configure git
        run: |
          git config --global user.email "${{ env.GIT_CI_EMAIL }}"
          git config --global user.name "${{ env.GIT_CI_USER }}"

          echo "Currently on: $(git rev-parse --abbrev-ref HEAD)"
          echo "Commit SHA: $(git rev-parse HEAD)"
          echo "COMMIT_SHA=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Checkout submodules
        working-directory: presto-native-execution
        run: |
          df -h
          make submodules

      - name: Extract version
        run: |
          VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "Raw version: $VERSION"

          if [ -z "$VERSION" ]; then
            echo "Failed to extract project version with Maven"
            exit 1
          fi

          if [[ "$VERSION" == *"-SNAPSHOT" ]]; then
            # Remove -SNAPSHOT and append commit SHA
            CLEAN_VERSION=${VERSION%-SNAPSHOT}
            TAG_VERSION="${CLEAN_VERSION}-${COMMIT_SHA}"
            echo "SNAPSHOT version detected, using: $TAG_VERSION"
          else
            TAG_VERSION="$VERSION"
            echo "Release version detected, using: $TAG_VERSION"
          fi

          echo "VERSION=$TAG_VERSION" >> $GITHUB_ENV

      - name: Login to DockerHub
        uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.0.0
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set image tag and base image
        run: |
          IMAGE_NAME="prestissimo"
          TAG_BASE="${{ env.ORG_NAME }}/${IMAGE_NAME}:${{ inputs.os }}-${{ env.VERSION }}-${{ matrix.arch }}"

          if [[ -n "${{ inputs.tag_suffix }}" ]]; then
            echo "IMAGE_TAG=${TAG_BASE}-${{ inputs.tag_suffix }}" >> $GITHUB_ENV
          else
            echo "IMAGE_TAG=${TAG_BASE}" >> $GITHUB_ENV
          fi

          if [[ "${{ inputs.os }}" == "ubuntu" ]]; then
            echo "BASE_IMAGE=ubuntu:22.04" >> $GITHUB_ENV
          else
            echo "BASE_IMAGE=quay.io/centos/centos:stream9" >> $GITHUB_ENV
          fi

          # Set dependency image based on whether we built it or need to use latest from dockerhub
          if [[ "${{ inputs.publish_dependency }}" == "true" ]]; then
            # Use the dependency image we just built
            DEPENDENCY_IMAGE="${{ env.ORG_NAME }}/presto-native-dependency:${{ inputs.os }}-${{ env.VERSION }}-${{ matrix.arch }}"
            if [[ -n "${{ inputs.tag_suffix }}" ]]; then
              DEPENDENCY_IMAGE="${DEPENDENCY_IMAGE}-${{ inputs.tag_suffix }}"
            fi
          else
            # Use the latest dependency image from dockerhub
            DEPENDENCY_IMAGE="${{ env.ORG_NAME }}/presto-native-dependency:${{ inputs.os }}-${{ matrix.arch }}-latest"
          fi
          echo "DEPENDENCY_IMAGE=${DEPENDENCY_IMAGE}" >> $GITHUB_ENV

          if [[ "${{ inputs.os }}" == "ubuntu" ]]; then
            LOCAL_IMAGE_TAG="presto/prestissimo-dependency:ubuntu-22.04"
          else
            LOCAL_IMAGE_TAG="presto/prestissimo-dependency:centos9"
          fi
          docker pull ${DEPENDENCY_IMAGE}
          docker tag ${DEPENDENCY_IMAGE} ${LOCAL_IMAGE_TAG}

      - name: Build prestissimo image
        working-directory: presto-native-execution
        run: |
          df -h
          echo "Using image tag: $IMAGE_TAG"
          echo "Using dependency image: ${{ env.DEPENDENCY_IMAGE }}"
          echo "Using base image: $BASE_IMAGE"
          EXTRA_CMAKE_FLAGS=" \
            -DPRESTO_ENABLE_PARQUET=ON \
            -DPRESTO_ENABLE_REMOTE_FUNCTIONS=ON \
            -DPRESTO_ENABLE_JWT=ON \
            -DPRESTO_STATS_REPORTER_TYPE=PROMETHEUS \
            -DPRESTO_MEMORY_CHECKER_TYPE=LINUX_MEMORY_CHECKER \
            -DPRESTO_ENABLE_SPATIAL=ON \
            -DPRESTO_ENABLE_TESTING=OFF \
            -DPRESTO_ENABLE_S3=ON"
          if [[ "${{ matrix.arch }}" == "arm64" ]]; then
            BUILD_ARGS="--build-arg ARM_BUILD_TARGET=generic"
          else
            BUILD_ARGS=""
          fi

          # Build the prestissimo image using standard Docker build
          docker build \
            --build-arg EXTRA_CMAKE_FLAGS="$EXTRA_CMAKE_FLAGS" \
            --build-arg DEPENDENCY_IMAGE=${{ env.DEPENDENCY_IMAGE }} \
            --build-arg BASE_IMAGE=$BASE_IMAGE \
            --build-arg OSNAME=${{ inputs.os }} \
            --build-arg BUILD_TYPE=Release \
            --build-arg NUM_THREADS=2 \
            ${BUILD_ARGS} \
            -f scripts/dockerfiles/prestissimo-runtime.dockerfile \
            -t ${{ env.IMAGE_TAG }} \
            .

      - name: Publish image
        run: |
          set -e
          docker push ${{ env.IMAGE_TAG }}

          if [[ "${{ inputs.tag_latest }}" == "true" ]]; then
            LATEST_TAG="${{ env.ORG_NAME }}/prestissimo:${{ inputs.os }}-${{ matrix.arch }}-latest"
            docker tag ${{ env.IMAGE_TAG }} ${LATEST_TAG}
            docker push ${LATEST_TAG}
            echo "Tagged and pushed as latest: ${LATEST_TAG}"
          fi

  create-prestissimo-manifest:
    if: (!failure() && !cancelled() && github.event.inputs.publish_prestissimo == 'true')
    needs: publish-prestissimo-image
    runs-on: ubuntu-latest
    environment: release
    permissions:
      packages: write
      contents: read
    steps:
      - name: Login to DockerHub
        uses: docker/login-action@184bdaa0721073962dff0199f1fb9940f07167d1 # v3.0.0
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.branch_or_tag }}
          fetch-depth: 1

      - name: Extract version
        run: |
          VERSION=$(./mvnw help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "Raw version: $VERSION"

          if [ -z "$VERSION" ]; then
            echo "Failed to extract project version with Maven"
            exit 1
          fi

          if [[ "$VERSION" == *"-SNAPSHOT" ]]; then
            # Remove -SNAPSHOT and append commit SHA
            CLEAN_VERSION=${VERSION%-SNAPSHOT}
            COMMIT_SHA=$(git rev-parse --short HEAD)
            TAG_VERSION="${CLEAN_VERSION}-${COMMIT_SHA}"
            echo "SNAPSHOT version detected, using: $TAG_VERSION"
          else
            TAG_VERSION="$VERSION"
            echo "Release version detected, using: $TAG_VERSION"
          fi

          echo "VERSION=$TAG_VERSION" >> $GITHUB_ENV

      - name: Create and push multi-arch manifest
        run: |
          ORG_NAME="${{ github.repository_owner }}"
          IMAGE_NAME="prestissimo"
          OS="${{ inputs.os }}"
          VERSION="${{ env.VERSION }}"

          # Determine tag suffix
          if [[ -n "${{ inputs.tag_suffix }}" ]]; then
            TAG_SUFFIX="-${{ inputs.tag_suffix }}"
          else
            TAG_SUFFIX=""
          fi

          # Create manifest for the versioned tag
          MANIFEST_TAG="${ORG_NAME}/${IMAGE_NAME}:${OS}-${VERSION}${TAG_SUFFIX}"
          AMD64_TAG="${ORG_NAME}/${IMAGE_NAME}:${OS}-${VERSION}-amd64${TAG_SUFFIX}"
          ARM64_TAG="${ORG_NAME}/${IMAGE_NAME}:${OS}-${VERSION}-arm64${TAG_SUFFIX}"

          echo "Creating manifest: ${MANIFEST_TAG}"
          docker manifest create ${MANIFEST_TAG} ${AMD64_TAG} ${ARM64_TAG}
          docker manifest push ${MANIFEST_TAG}

          # Create latest manifest if requested
          if [[ "${{ inputs.tag_latest }}" == "true" ]]; then
            # Create OS-specific latest manifest
            LATEST_MANIFEST="${ORG_NAME}/${IMAGE_NAME}:${OS}-latest"
            LATEST_AMD64="${ORG_NAME}/${IMAGE_NAME}:${OS}-amd64-latest"
            LATEST_ARM64="${ORG_NAME}/${IMAGE_NAME}:${OS}-arm64-latest"

            echo "Creating OS-specific latest manifest: ${LATEST_MANIFEST}"
            docker manifest create ${LATEST_MANIFEST} ${LATEST_AMD64} ${LATEST_ARM64}
            docker manifest push ${LATEST_MANIFEST}

            # If OS is centos, also tag as latest (without OS prefix)
            if [[ "${OS}" == "centos" ]]; then
              GLOBAL_LATEST="${ORG_NAME}/${IMAGE_NAME}:latest"
              echo "Creating global latest manifest: ${GLOBAL_LATEST}"
              docker manifest create ${GLOBAL_LATEST} ${LATEST_AMD64} ${LATEST_ARM64}
              docker manifest push ${GLOBAL_LATEST}
            fi
          fi
